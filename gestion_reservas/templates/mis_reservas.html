{% extends 'base.html' %}
{% load static %}

{% block title %}Mis Reservas | ReDe{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'reservas_estilos.css' %}">
<div class="max-w-7xl mx-auto px-4 py-6">
        <h1 class="text-3xl font-bold text-gray-800 mb-8">Mis Reservas</h1>
                <div id="notificacion" class="hidden mb-6 p-4 rounded border text-sm flex items-start gap-3">
                        <span id="notificacion-icono" class="shrink-0"></span>
                        <span id="notificacion-texto" class="flex-1"></span>
                </div>

        <!-- Listado -->
        <section class="mb-12 relative">
                <div class="flex items-center">
                        <button id="scroll-left" class="hidden md:block bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 focus:outline-none mr-2 z-10 absolute left-0 -translate-y-1/2 top-1/2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"/></svg>
                        </button>
                        <div id="reservas-container" class="flex space-x-6 overflow-x-auto scroll-smooth scrollbar-hide mx-10 pb-4">
                                {% for reserva in reservas %}
                                <div class="reserva-card bg-white border border-gray-200 rounded-xl shadow hover:shadow-lg transition flex-shrink-0 w-72 relative">
                                        <div class="h-40 w-full overflow-hidden rounded-t-xl">
                                                <img class="w-full h-full object-cover" src="{% static 'images/'|add:reserva.espacio|lower|add:'.jpg' %}" alt="{{ reserva.espacio }}" />
                                        </div>
                                        <div class="p-4 space-y-2">
                                                <div class="flex items-center justify-between">
                                                        <h3 class="text-lg font-semibold text-gray-800">{{ reserva.espacio }}</h3>
                                                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">ID {{ reserva.id }}</span>
                                                </div>
                                                <div class="text-sm text-gray-600 leading-5">
                                                        <p><span class="font-medium text-gray-700">Fecha:</span> {{ reserva.momento_inicio|date:"d/m/Y" }}</p>
                                                        <p><span class="font-medium text-gray-700">Horario:</span> {{ reserva.momento_inicio|date:"H:i" }} - {{ reserva.momento_fin|date:"H:i" }}</p>
                                                </div>
                                                <div class="flex gap-2 pt-2">
                                                        <button data-id="{{ reserva.id }}" data-fecha="{{ reserva.momento_inicio|date:'Y-m-d' }}" data-hora="{{ reserva.momento_inicio|date:'H' }}" class="editar-reserva-btn flex-1 text-white bg-blue-500 hover:bg-blue-600 font-medium rounded-lg text-sm px-3 py-2 transition">Modificar hora</button>
                                                        <button data-id="{{ reserva.id }}" class="eliminar-reserva-btn flex-1 text-white bg-red-500 hover:bg-red-600 font-medium rounded-lg text-sm px-3 py-2 transition">Eliminar</button>
                                                </div>
                                        </div>
                                </div>
                                {% empty %}
                                <p class="text-gray-600">No tienes reservas activas. <a href="/reservas/hacer" class="text-blue-600 hover:underline font-medium">Crear una nueva</a></p>
                                {% endfor %}
                        </div>
                        <button id="scroll-right" class="hidden md:block bg-blue-500 text-white p-2 rounded-full hover:bg-blue-600 focus:outline-none ml-2 z-10 absolute right-0 -translate-y-1/2 top-1/2">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"/></svg>
                        </button>
                </div>
        </section>

        <!-- Panel de edición (solo aparece tras pulsar Modificar) -->
        <section id="panel-edicion" class="hidden bg-white border border-gray-200 rounded-xl shadow p-6 max-w-3xl mx-auto">
                <h2 class="text-2xl font-semibold text-gray-800 mb-4 flex items-center gap-2">
                        <svg class="w-6 h-6 text-blue-500" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/></svg>
                        Modificar hora de la reserva
                </h2>
                <div class="bg-blue-50 border border-blue-200 text-blue-800 text-sm rounded p-3 mb-4">
                        Solo puedes cambiar la hora. Si te has equivocado de deporte, elimina la reserva y crea una nueva.
                </div>
                <form id="form-edicion" class="space-y-6">
                        {% csrf_token %}
                        <input type="hidden" id="reserva-id" />
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                                <div class="md:col-span-1">
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Deporte</label>
                                        <div class="flex items-center gap-2 bg-gray-50 border border-gray-200 rounded px-3 py-2">
                                                <img id="preview-deporte" src="" alt="Deporte" class="w-10 h-10 object-cover rounded" />
                                                <span id="texto-deporte" class="font-medium text-gray-800"></span>
                                        </div>
                                </div>
                                <div>
                                        <label for="fecha" class="block text-sm font-medium text-gray-700 mb-1">Fecha</label>
                                        <input type="date" id="fecha" class="w-full border border-gray-300 rounded px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">
                                </div>
                                <div>
                                        <label class="block text-sm font-medium text-gray-700 mb-1">Hora</label>
                                        <div id="grid-horas" class="grid grid-cols-4 gap-2"></div>
                                </div>
                        </div>
                        <div class="flex justify-end gap-3 pt-4">
                                <button type="button" id="cancelar-edicion" class="px-5 py-2 rounded bg-gray-200 hover:bg-gray-300 text-gray-800">Cancelar</button>
                                <button type="submit" class="px-5 py-2 rounded bg-green-500 hover:bg-green-600 text-white font-medium">Guardar cambios</button>
                        </div>
                </form>
        </section>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
        // Notificación por query params
        const notif = document.getElementById('notificacion');
        const qp = new URLSearchParams(window.location.search);
                if(qp.get('cancel')==='1'){
                        mostrarBanner('Has cancelado la creación de la reserva.', 'info');
                } else if(qp.get('ok')==='1'){
                        mostrarBanner('Operación realizada con éxito.', 'success');
        }
                function mostrarBanner(msg, tipo){
                        const icono = document.getElementById('notificacion-icono');
                        const texto = document.getElementById('notificacion-texto');
                        // Reset clases
                        notif.className='mb-6 p-4 rounded border text-sm flex items-start gap-3';
                        if(tipo==='info') notif.classList.add('bg-blue-50','border-blue-200','text-blue-800');
                        if(tipo==='success') notif.classList.add('bg-green-50','border-green-200','text-green-800');
                        icono.innerHTML = tipo==='info' ? 'ℹ️' : '✅';
                        texto.textContent = msg;
                        notif.classList.remove('hidden');
                        setTimeout(()=> notif.classList.add('hidden'), 5000);
        }
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    const reservasContainer = document.getElementById('reservas-container');
    const scrollLeftBtn = document.getElementById('scroll-left');
    const scrollRightBtn = document.getElementById('scroll-right');
    const panel = document.getElementById('panel-edicion');
    const reservaIdInput = document.getElementById('reserva-id');
    const fechaInput = document.getElementById('fecha');
    const gridHoras = document.getElementById('grid-horas');
    const textoDeporte = document.getElementById('texto-deporte');
    const previewDeporte = document.getElementById('preview-deporte');
    let horaSeleccionada = null;
    let deporteActual = null;

    const horas = Array.from({length:14}, (_,i)=> (i+8).toString().padStart(2,'0')+':00'); // 08:00-21:00

    function toggleScrollButtons(){
        if(!reservasContainer) return;
        scrollLeftBtn.classList.toggle('hidden', reservasContainer.scrollLeft <=0);
        scrollRightBtn.classList.toggle('hidden', reservasContainer.scrollLeft + reservasContainer.clientWidth >= reservasContainer.scrollWidth - 5);
    }
    if(reservasContainer){
        reservasContainer.addEventListener('scroll', toggleScrollButtons);
        window.addEventListener('resize', toggleScrollButtons);
        toggleScrollButtons();
    }
    scrollLeftBtn?.addEventListener('click', ()=> reservasContainer.scrollBy({left:-300, behavior:'smooth'}));
    scrollRightBtn?.addEventListener('click', ()=> reservasContainer.scrollBy({left:300, behavior:'smooth'}));

    // Construir grid horas
    function renderHoras(ocupadas){
        gridHoras.innerHTML='';
        horas.forEach(h=>{
            const btn=document.createElement('button');
            btn.type='button';
            btn.textContent=h;
            btn.className='px-2 py-1 text-sm rounded border transition';
            const disabled = ocupadas.includes(h);
            if(disabled){
                btn.disabled=true;
                btn.className+=' bg-red-100 text-red-500 border-red-200 cursor-not-allowed';
            } else {
                btn.className+=' bg-white text-gray-700 border-gray-300 hover:bg-blue-50 hover:border-blue-500';
                btn.addEventListener('click', ()=>{
                    gridHoras.querySelectorAll('button:not(:disabled)').forEach(b=> b.classList.remove('bg-blue-500','text-white','border-blue-500'));
                    btn.classList.add('bg-blue-500','text-black','border-blue-500');
                    horaSeleccionada=h;
                });
            }
            gridHoras.appendChild(btn);
        });
    }

    async function cargarOcupadas(fecha){
        if(!fecha || !deporteActual) return renderHoras([]);
        const res = await fetch('/reservas/horarios-disponibles/', {
            method:'POST',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
            body: JSON.stringify({espacio: deporteActual, fecha: fecha, reserva_id: reservaIdInput.value})
        });
        const data = await res.json();
        renderHoras(data.horarios_ocupados || []);
    }

    fechaInput.addEventListener('change', ()=> cargarOcupadas(fechaInput.value));

    // Editar
    document.querySelectorAll('.editar-reserva-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            const id = btn.dataset.id;
            const fecha = btn.dataset.fecha;
            const hora = btn.dataset.hora.padStart(2,'0')+':00';
            const card = btn.closest('.reserva-card');
            deporteActual = card.querySelector('h3').textContent.trim();
            previewDeporte.src = `/static/images/${deporteActual.toLowerCase()}.jpg`;
            textoDeporte.textContent = deporteActual;
            reservaIdInput.value = id;
            fechaInput.value = fecha;
            panel.classList.remove('hidden');
            cargarOcupadas(fecha).then(()=>{
                const target = Array.from(gridHoras.querySelectorAll('button')).find(b=> b.textContent===hora);
                if(target && !target.disabled){
                    target.click();
                }
            });
            panel.scrollIntoView({behavior:'smooth'});
        });
    });

    document.getElementById('cancelar-edicion').addEventListener('click', ()=>{
        panel.classList.add('hidden');
        reservaIdInput.value='';
        horaSeleccionada=null;
    });

    // Eliminar
    document.querySelectorAll('.eliminar-reserva-btn').forEach(btn=>{
        btn.addEventListener('click', ()=>{
            if(!confirm('¿Eliminar esta reserva?')) return;
            const id = btn.dataset.id;
            fetch(`/reservas/eliminar/${id}/`, {method:'DELETE', headers:{'X-CSRFToken':csrfToken}})
                .then(r=>r.json()).then(d=>{ if(d.success){ location.reload(); } else { alert(d.error||'Error'); } });
        });
    });

    // Guardar modificación
    document.getElementById('form-edicion').addEventListener('submit', e=>{
        e.preventDefault();
        if(!horaSeleccionada){ alert('Selecciona una hora'); return; }
        const id = reservaIdInput.value;
        const inicio = `${fechaInput.value}T${horaSeleccionada}:00`;
        const horaFin = (parseInt(horaSeleccionada.split(':')[0])+1).toString().padStart(2,'0')+':00';
        const fin = `${fechaInput.value}T${horaFin}:00`;
        fetch(`/reservas/modificar/${id}/`, {
            method:'PUT',
            headers:{'Content-Type':'application/json','X-CSRFToken':csrfToken},
            body: JSON.stringify({momento_inicio:inicio, momento_fin:fin})
        }).then(r=>r.json()).then(d=>{
            if(d.error){ alert(d.error); return; }
            alert('Reserva actualizada');
            location.reload();
        });
    });
});
</script>
{% endblock %}