{% extends 'base.html' %}
{% load static %}

{% block title %}Hacer Reserva | ReDe{% endblock %}

{% block content %}
<link rel="stylesheet" href="{% static 'reservas_estilos.css' %}">

<div class="max-w-4xl mx-auto px-4 py-6">
    <!-- Título de la Página -->
    <h1 class="text-3xl font-bold text-gray-800 mb-6">Hacer Nueva Reserva</h1>

    <!-- Pasos del proceso -->
    <div class="mb-8">
        <div class="flex items-center space-x-4">
            <div id="step-1" class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-blue-500 text-white rounded-full font-bold text-sm">1</div>
                <span class="ml-2 text-blue-500 font-medium">Elegir Deporte</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div id="step-2" class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-300 text-gray-600 rounded-full font-bold text-sm">2</div>
                <span class="ml-2 text-gray-600">Seleccionar Horario</span>
            </div>
            <div class="w-12 h-0.5 bg-gray-300"></div>
            <div id="step-3" class="flex items-center">
                <div class="flex items-center justify-center w-8 h-8 bg-gray-300 text-gray-600 rounded-full font-bold text-sm">3</div>
                <span class="ml-2 text-gray-600">Confirmar</span>
            </div>
        </div>
    </div>

    <form id="reserva-form" class="bg-white p-6 rounded-lg shadow-md relative">
        <a id="cancelar-flujo" href="/mis-reservas/?cancel=1" class="absolute right-4 top-4 text-sm bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded inline-flex items-center">Cancelar</a>
        {% csrf_token %}
        <input type="hidden" id="reserva-id" name="reserva-id" value="">
        
        <!-- Paso 1: Selección de Deporte -->
        <div id="paso-1" class="step-content">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Paso 1: Selecciona tu deporte</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                {% for d in deportes %}
                {% with nombre_archivo=d.code|lower %}
                {% comment %} Normalizar posibles tildes para nombres de archivo {% endcomment %}
                {% if 'fútbol' in nombre_archivo %}{% with 'futbol' as nombre_archivo %}{% endwith %}{% endif %}
                {% if 'pádel' in nombre_archivo %}{% with 'padel' as nombre_archivo %}{% endwith %}{% endif %}
                <div class="deporte-option group border-2 border-gray-200 rounded-xl cursor-pointer overflow-hidden transition relative hover:border-blue-500" data-deporte="{{ d.code }}">
                    <div class="h-40 w-full overflow-hidden relative">
                        <img src="{% static 'images/' %}{{ nombre_archivo }}.jpg" alt="{{ d.titulo }}" onerror="this.onerror=null;this.src='{% static 'images/placeholder.jpg' %}';" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300">
                        <div class="absolute inset-0 bg-gradient-to-t from-black/60 to-black/10 opacity-60 group-hover:opacity-70 transition"></div>
                        <div class="absolute bottom-2 left-2 text-white">
                            <h4 class="font-semibold text-lg leading-5">{{ d.titulo }}</h4>
                            <p class="text-xs text-gray-200">{{ d.desc }}</p>
                        </div>
                        <div class="absolute top-2 right-2 hidden group-[.selected]:flex">
                            <span class="bg-blue-500 text-white text-xs px-2 py-1 rounded shadow">Seleccionado</span>
                        </div>
                    </div>
                </div>
                {% endwith %}
                {% endfor %}
            </div>
            
            <div class="mt-6 flex justify-end">
                <button type="button" id="siguiente-paso-1" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                    Siguiente
                </button>
            </div>
        </div>

        <!-- Paso 2: Selección de Horario -->
        <div id="paso-2" class="step-content hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Paso 2: Selecciona la fecha y hora</h3>
            
            <!-- Selección de fecha -->
            <div class="mb-6">
                <label for="fecha-reserva" class="block text-sm font-medium text-gray-700 mb-2">Fecha de la reserva</label>
                <input type="date" id="fecha-reserva" class="block w-full px-3 py-2 border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-blue-500 focus:border-blue-500">
            </div>

            <!-- Grid de horarios disponibles -->
            <div class="mb-6">
                <h4 class="text-sm font-medium text-gray-700 mb-3">Horarios disponibles (cada reserva dura 1 hora)</h4>
                <div id="horarios-grid" class="grid grid-cols-3 md:grid-cols-4 lg:grid-cols-6 gap-3">
                    <!-- Los horarios se generarán dinámicamente -->
                </div>
            </div>

            <div class="flex justify-between">
                <button type="button" id="atras-paso-2" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    Atrás
                </button>
                <button type="button" id="siguiente-paso-2" class="bg-blue-500 text-white px-6 py-2 rounded-lg hover:bg-blue-600 transition-colors disabled:bg-gray-300 disabled:cursor-not-allowed" disabled>
                    Siguiente
                </button>
            </div>
        </div>

        <!-- Paso 3: Confirmación -->
        <div id="paso-3" class="step-content hidden">
            <h3 class="text-lg font-semibold text-gray-800 mb-4">Paso 3: Confirma tu reserva</h3>
            
            <div class="bg-gray-50 rounded-lg p-6 mb-6">
                <h4 class="font-semibold text-gray-800 mb-4">Resumen de tu reserva</h4>
                <div class="space-y-3">
                    <div class="flex justify-between">
                        <span class="text-gray-600">Deporte:</span>
                        <span id="resumen-deporte" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Fecha:</span>
                        <span id="resumen-fecha" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Horario:</span>
                        <span id="resumen-horario" class="font-medium"></span>
                    </div>
                    <div class="flex justify-between">
                        <span class="text-gray-600">Duración:</span>
                        <span class="font-medium">1 hora</span>
                    </div>
                    <hr class="my-3">
                </div>
            </div>

            <div class="flex justify-between">
                <button type="button" id="atras-paso-3" class="bg-gray-500 text-white px-6 py-2 rounded-lg hover:bg-gray-600 transition-colors">
                    Atrás
                </button>
                <button type="submit" id="confirmar-reserva" class="bg-green-500 text-white px-6 py-2 rounded-lg hover:bg-green-600 transition-colors">
                    Confirmar Reserva
                </button>
            </div>
        </div>
    </form>
</div>

<!-- Loading modal -->
<div id="loading-modal" class="fixed inset-0 bg-gray-600 bg-opacity-50 hidden items-center justify-center z-50">
    <div class="bg-white rounded-lg p-6 max-w-sm w-full mx-4">
        <div class="flex items-center justify-center">
            <div class="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-500 mr-3"></div>
            <span class="text-gray-700">Procesando reserva...</span>
        </div>
    </div>
</div>

<script src="{% static 'crear_reserva_mejorada.js' %}"></script>
{% endblock %}